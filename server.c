/*
 * date_proc.c - remote procedures; called by server stub.
 */
#include <rpc/rpc.h>	/* standard RPC include file */
#include <time.h>
#include <sys/types.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "date.h"	/* this file is generated by rpcgen */

#define MAX_LEN 100
/*
 * Return the binary date and time.
 */
char ** date_1(long *option)
{
    struct tm *timeptr; /* Pointer to time structure      */
    time_t clock;       /* Clock value (in secs)          */
    static char *ptr;   /* Return string                  */
    static char err[] = "Invalid Response \0";
    static char s[MAX_LEN];

    clock = time(0);
    timeptr = localtime(&clock);

    switch(*option)
        {
        case 1: strftime(s,MAX_LEN,"%A, %B %d, %Y",timeptr);
                // Date Only
                ptr=s;
                break;

        case 2: strftime(s,MAX_LEN,"%T",timeptr);
                // Time Only
                ptr=s;
                break;

        case 3: strftime(s,MAX_LEN,"%A, %B %d, %Y - %T",timeptr);
                // Time and Date
                ptr=s;
                break;

        case 4: 
                char formatted_output[100];
                // CPU Usage
                char* cpu_usage_str = format_cpu_usage(formatted_output, sizeof(formatted_output));
                ptr=cpu_usage_str;
                break;

        case 5: 
                // Memory Usage
                ptr=s;
                break;

        case 6: 
                // Process Count
                ptr=s;
                break;
        
        case 7: 
                // Load procs per minute
                ptr=s;
                break;

        default: ptr=err;
                 break;
        }
    return(&ptr);
}

float get_cpu_usage() {
        FILE *fp;
        char buffer[1024];
        long user, nice, system, idle, total;
        long prev_user, prev_nice, prev_system, prev_idle, prev_total;
        static long last_user = 0, last_nice = 0, last_system = 0, last_idle = 0, last_total = 0;

        fp = fopen("/proc/stat", "r");
        if (!fp) {
                perror("fopen");
                return -1.0;
        }

        // Read CPU stats
        fgets(buffer, sizeof(buffer), fp);
        sscanf(buffer, "cpu %ld %ld %ld %ld", &user, &nice, &system, &idle);
        fclose(fp);

        // Calculate the total and idle times
        total = user + nice + system + idle;
        long delta_total = total - last_total;
        long delta_idle = idle - last_idle;

        // Calculate CPU usage as a percentage
        float cpu_usage = 0.0;
        if (delta_total > 0) {
                cpu_usage = 100.0 * (1.0 - ((float)delta_idle / (float)delta_total));
        }

        // Store current values for next calculation
        last_user = user;
        last_nice = nice;
        last_system = system;
        last_idle = idle;
        last_total = total;

        return cpu_usage;
}

// Function to format the current CPU usage as a string
char* format_cpu_usage(char *output, size_t max_len) {
    float cpu_usage = get_cpu_usage();
    if (cpu_usage < 0.0) {
        snprintf(output, max_len, "Error getting CPU usage");
    } 
    else {
        snprintf(output, max_len, "CPU Usage: %.2f%%", cpu_usage);
    }
    return output;
}
